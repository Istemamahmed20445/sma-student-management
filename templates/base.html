{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Student Management System{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Student Management System for Shahriar's Medical Academy">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SMA Student Management">
    <meta name="msapplication-TileColor" content="#2563eb">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- iOS PWA Enhancements -->
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-touch-startup-image" content="/static/images/pwa/icon-512x512.png">
    
    <!-- Android PWA Enhancements -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="SMA Student Management">
    
    <!-- Critical PWA Meta Tags -->
    <meta name="mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-orientations" content="portrait">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="{% static 'images/pwa/icon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'images/pwa/icon-152x152.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/pwa/icon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="167x167" href="{% static 'images/pwa/icon-192x192.png' %}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/pwa/icon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/pwa/icon-16x16.png' %}">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileImage" content="{% static 'images/pwa/icon-144x144.png' %}">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAC6jhWOKd06VhjV7RTyntVZwkDPGDcf-4",
            authDomain: "sma-student.firebaseapp.com",
            projectId: "sma-student",
            storageBucket: "sma-student.firebasestorage.app",
            messagingSenderId: "621019846757",
            appId: "1:621019846757:web:02faa1536bbb73969e0e8c"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // Make Firebase available globally
        window.firebase = { app, auth, db, storage };
    </script>
    
    <!-- Custom CSS -->
    <style>
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .card-shadow:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-800 flex items-center">
                            <img src="{% static 'images/sma-logo.jpg' %}" alt="SMA Logo" class="h-8 w-auto mr-3" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                            <i class="fas fa-graduation-cap text-blue-600 mr-2" style="display: none;"></i>
                            Shahriar's Medical Academy
                        </h1>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    {% if user.is_authenticated %}
                        <!-- Notifications -->
                        <div class="relative">
                            <a href="{% url 'core:notifications' %}" class="text-gray-600 hover:text-gray-900 relative">
                                <i class="fas fa-bell text-xl"></i>
                            </a>
                        </div>
                        
                        <!-- User Menu -->
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <div class="h-8 w-8 rounded-full bg-blue-500 flex items-center justify-center">
                                    <span class="text-white font-medium">{{ user.first_name.0|default:user.username.0|upper }}</span>
                                </div>
                                <span class="ml-2 text-gray-700">{{ user.get_full_name|default:user.username }}</span>
                                <i class="fas fa-chevron-down ml-1 text-gray-400"></i>
                            </button>
                            
                            <div x-show="open" @click.away="open = false" x-transition class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                                <a href="{% url 'accounts:profile' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-user mr-2"></i>Profile
                                </a>
                                <a href="{% url 'accounts:edit_profile' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-edit mr-2"></i>Edit Profile
                                </a>
                                <a href="{% url 'accounts:password_change' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-key mr-2"></i>Change Password
                                </a>
                                <hr class="my-1">
                                <form method="post" action="{% url 'accounts:logout' %}" class="block">
                                    {% csrf_token %}
                                    <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% else %}
                        <a href="{% url 'accounts:login' %}" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            Login
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <div class="flex pt-16">
        {% if user.is_authenticated %}
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg h-screen fixed left-0 top-16 overflow-y-auto">
            <nav class="mt-5 px-2">
                <div class="space-y-1">
                    <!-- Dashboard -->
                    <a href="{% url 'core:dashboard' %}" class="group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if request.resolver_match.url_name == 'dashboard' %}bg-blue-100 text-blue-900{% else %}text-gray-600 hover:bg-gray-50 hover:text-gray-900{% endif %}">
                        <i class="fas fa-tachometer-alt mr-3 text-lg"></i>
                        Dashboard
                    </a>
                    
                    <!-- Students -->
                    <div class="space-y-1">
                        <a href="{% url 'students:student_list' %}" class="group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'students' in request.resolver_match.namespace %}bg-blue-100 text-blue-900{% else %}text-gray-600 hover:bg-gray-50 hover:text-gray-900{% endif %}">
                            <i class="fas fa-user-graduate mr-3 text-lg"></i>
                            Students
                        </a>
                        <a href="{% url 'students:application_list' %}" class="group flex items-center px-2 py-2 text-sm font-medium rounded-md ml-6 text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                            <i class="fas fa-file-alt mr-3 text-sm"></i>
                            Applications
                        </a>
                    </div>
                    
                    <!-- Batches -->
                    <a href="{% url 'batches:batch_list' %}" class="group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'batches' in request.resolver_match.namespace %}bg-blue-100 text-blue-900{% else %}text-gray-600 hover:bg-gray-50 hover:text-gray-900{% endif %}">
                        <i class="fas fa-users mr-3 text-lg"></i>
                        Batches
                    </a>
                    
                    <!-- Fees -->
                    <a href="{% url 'fees:payment_dashboard' %}" class="group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'fees' in request.resolver_match.namespace %}bg-blue-100 text-blue-900{% else %}text-gray-600 hover:bg-gray-50 hover:text-gray-900{% endif %}">
                        <i class="fas fa-money-bill-wave mr-3 text-lg"></i>
                        Fees & Payments
                    </a>
                    
                    <!-- Contacts -->
                    <a href="{% url 'contacts:contact_list' %}" class="group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'contacts' in request.resolver_match.namespace %}bg-blue-100 text-blue-900{% else %}text-gray-600 hover:bg-gray-50 hover:text-gray-900{% endif %}">
                        <i class="fas fa-address-book mr-3 text-lg"></i>
                        Contacts
                    </a>
                    
                    <!-- Admin Only -->
                    {% if user.profile.role == 'admin' %}
                    <div class="border-t border-gray-200 pt-4">
                        <div class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Administration</div>
                        <div class="mt-2 space-y-1">
                            <a href="/admin/" class="group flex items-center px-2 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                                <i class="fas fa-cog mr-3 text-lg"></i>
                                Admin Panel
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 ml-64">
        {% else %}
        <!-- Main Content (No Sidebar) -->
        <div class="flex-1">
        {% endif %}
            <!-- Messages -->
            {% if messages %}
                <div class="max-w-7xl mx-auto px-4 py-4">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} mb-4 p-4 rounded-md {% if message.tags == 'error' %}bg-red-100 border border-red-400 text-red-700{% elif message.tags == 'success' %}bg-green-100 border border-green-400 text-green-700{% elif message.tags == 'warning' %}bg-yellow-100 border border-yellow-400 text-yellow-700{% else %}bg-blue-100 border border-blue-400 text-blue-700{% endif %}">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    {% if message.tags == 'error' %}
                                        <i class="fas fa-exclamation-circle"></i>
                                    {% elif message.tags == 'success' %}
                                        <i class="fas fa-check-circle"></i>
                                    {% elif message.tags == 'warning' %}
                                        <i class="fas fa-exclamation-triangle"></i>
                                    {% else %}
                                        <i class="fas fa-info-circle"></i>
                                    {% endif %}
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm">{{ message }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- Page Content -->
            <main class="max-w-7xl mx-auto px-4 py-6">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <!-- Alpine.js for interactive components -->
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Currency conversion
        async function convertCurrency(amount, fromCurrency, toCurrency) {
            try {
                const response = await fetch('/api/currency/convert/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        from_currency: fromCurrency,
                        to_currency: toCurrency
                    })
                });
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Currency conversion error:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Format currency
        function formatCurrency(amount, currency) {
            const symbols = {
                'USD': '$',
                'BDT': '‡ß≥',
                'AUD': 'A$',
                'INR': '‚Çπ',
                'PKR': '‚Ç®'
            };
            
            const symbol = symbols[currency] || currency;
            return `${symbol}${parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        // Auto-hide alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    setTimeout(() => {
                        alert.remove();
                    }, 300);
                }, 5000);
            });
            
            // Initialize PWA
            initializePWA();
        });
        
        // Check PWA requirements
        function checkPWARequirements() {
            console.log('üîç Checking PWA Requirements...');
            
            const requirements = {
                https: location.protocol === 'https:' || location.hostname === 'localhost',
                serviceWorker: 'serviceWorker' in navigator,
                manifest: document.querySelector('link[rel="manifest"]') !== null,
                icons: document.querySelectorAll('link[rel="icon"]').length > 0,
                appleTouchIcon: document.querySelector('link[rel="apple-touch-icon"]') !== null
            };
            
            console.log('PWA Requirements Check:', requirements);
            
            const allMet = Object.values(requirements).every(req => req);
            console.log('All PWA requirements met:', allMet);
            
            if (!allMet) {
                console.warn('‚ö†Ô∏è Some PWA requirements are not met:', requirements);
            }
            
            return requirements;
        }
        
        // PWA Initialization
        function initializePWA() {
            console.log('üöÄ Initializing PWA...');
            console.log('User Agent:', navigator.userAgent);
            console.log('Service Worker Support:', 'serviceWorker' in navigator);
            console.log('Display Mode:', window.matchMedia('(display-mode: standalone)').matches);
            
            // Check PWA requirements
            checkPWARequirements();
            
            // Register Service Worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/static/sw.js')
                        .then((registration) => {
                            console.log('Service Worker registered successfully:', registration.scope);
                            
                            // Check for updates
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // New content is available, show update notification
                                        showUpdateNotification();
                                    }
                                });
                            });
                        })
                        .catch((error) => {
                            console.log('Service Worker registration failed:', error);
                        });
                });
            }
            
            // Handle PWA Install Prompt
            let deferredPrompt;
            const installButton = document.getElementById('install-button');
            
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('PWA install prompt triggered');
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install button if it exists
                if (installButton) {
                    installButton.style.display = 'block';
                    installButton.addEventListener('click', () => {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('User accepted the install prompt');
                            } else {
                                console.log('User dismissed the install prompt');
                            }
                            deferredPrompt = null;
                            installButton.style.display = 'none';
                        });
                    });
                }
                
                // Also show a custom install banner for better visibility
                showInstallBanner();
            });
            
            // Handle PWA installed event
            window.addEventListener('appinstalled', (evt) => {
                console.log('PWA was installed');
                if (installButton) {
                    installButton.style.display = 'none';
                }
                hideInstallBanner();
            });
            
            // Check if app is already installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                console.log('App is already installed');
                if (installButton) {
                    installButton.style.display = 'none';
                }
            }
            
            // Initialize IndexedDB for offline storage
            if ('indexedDB' in window) {
                const request = indexedDB.open('SMAOfflineDB', 1);
                
                request.onerror = () => {
                    console.error('Failed to open IndexedDB');
                };
                
                request.onupgradeneeded = () => {
                    const db = request.result;
                    
                    if (!db.objectStoreNames.contains('submissions')) {
                        const store = db.createObjectStore('submissions', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
                
                request.onsuccess = () => {
                    console.log('IndexedDB initialized successfully');
                };
            }
        }
        
        // Show update notification
        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>New version available!</span>
                    <button onclick="updateApp()" class="ml-4 bg-white text-blue-500 px-3 py-1 rounded text-sm font-medium">
                        Update
                    </button>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }
        
        // Update app function
        function updateApp() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then((registration) => {
                    if (registration && registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        window.location.reload();
                    }
                });
            }
        }
        
        // Handle offline/online status
        function updateOnlineStatus() {
            const status = navigator.onLine ? 'online' : 'offline';
            console.log('Connection status:', status);
            
            // Show offline indicator
            if (!navigator.onLine) {
                showOfflineIndicator();
            } else {
                hideOfflineIndicator();
            }
        }
        
        function showOfflineIndicator() {
            let indicator = document.getElementById('offline-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'offline-indicator';
                indicator.className = 'fixed bottom-4 left-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                indicator.innerHTML = '<i class="fas fa-wifi-slash mr-2"></i>You are offline';
                document.body.appendChild(indicator);
            }
        }
        
        function hideOfflineIndicator() {
            const indicator = document.getElementById('offline-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // Listen for online/offline events
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Initial status check
        updateOnlineStatus();
        
        // Show install banner function
        function showInstallBanner() {
            // Don't show if already installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return;
            }
            
            let banner = document.getElementById('install-banner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'install-banner';
                banner.className = 'fixed top-0 left-0 right-0 bg-blue-600 text-white px-4 py-3 shadow-lg z-50 flex items-center justify-between';
                banner.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-mobile-alt mr-2"></i>
                        <span class="text-sm font-medium">Install SMA App for better experience!</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="installPWA()" class="bg-white text-blue-600 px-3 py-1 rounded text-sm font-medium hover:bg-gray-100">
                            Install
                        </button>
                        <button onclick="hideInstallBanner()" class="text-white hover:text-gray-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                document.body.appendChild(banner);
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    hideInstallBanner();
                }, 10000);
            }
        }
        
        // Hide install banner function
        function hideInstallBanner() {
            const banner = document.getElementById('install-banner');
            if (banner) {
                banner.remove();
            }
        }
        
        // Install PWA function
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                    hideInstallBanner();
                });
            } else {
                // Fallback for iOS Safari
                alert('To install this app on your iOS device, tap the Share button and then "Add to Home Screen".');
            }
        }
        
        // Show install instructions function
        function showInstallInstructions() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            const isChrome = /Chrome/.test(navigator.userAgent);
            
            let instructions = '';
            
            if (isIOS) {
                instructions = `
                    <div class="text-left">
                        <h3 class="text-lg font-semibold mb-3">üì± Install on iOS:</h3>
                        <ol class="list-decimal list-inside space-y-2 text-sm">
                            <li>Tap the <strong>Share</strong> button (üì§) at the bottom of Safari</li>
                            <li>Scroll down and tap <strong>"Add to Home Screen"</strong></li>
                            <li>Tap <strong>"Add"</strong> to confirm</li>
                            <li>The SMA app will appear on your home screen!</li>
                        </ol>
                    </div>
                `;
            } else if (isAndroid && isChrome) {
                instructions = `
                    <div class="text-left">
                        <h3 class="text-lg font-semibold mb-3">ü§ñ Install on Android:</h3>
                        <ol class="list-decimal list-inside space-y-2 text-sm">
                            <li>Tap the <strong>menu</strong> (‚ãÆ) in Chrome</li>
                            <li>Tap <strong>"Add to Home screen"</strong> or <strong>"Install app"</strong></li>
                            <li>Tap <strong>"Add"</strong> or <strong>"Install"</strong> to confirm</li>
                            <li>The SMA app will install and appear on your home screen!</li>
                        </ol>
                    </div>
                `;
            } else {
                instructions = `
                    <div class="text-left">
                        <h3 class="text-lg font-semibold mb-3">üíª Install Instructions:</h3>
                        <div class="space-y-3 text-sm">
                            <div>
                                <strong>Chrome/Edge Desktop:</strong>
                                <p>Look for the install icon (‚¨áÔ∏è) in the address bar and click it.</p>
                            </div>
                            <div>
                                <strong>iOS Safari:</strong>
                                <p>Tap Share ‚Üí "Add to Home Screen"</p>
                            </div>
                            <div>
                                <strong>Android Chrome:</strong>
                                <p>Tap menu ‚Üí "Add to Home screen"</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900">Install SMA App</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${instructions}
                    <div class="mt-6 flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Got it!
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Show PWA status function
        function showPWAStatus() {
            const requirements = checkPWARequirements();
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const hasServiceWorker = 'serviceWorker' in navigator;
            
            let statusHtml = `
                <div class="text-left space-y-3">
                    <h3 class="text-lg font-semibold mb-3">üìä PWA Status Report</h3>
                    
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>HTTPS/Localhost:</span>
                            <span class="${requirements.https ? 'text-green-600' : 'text-red-600'}">
                                ${requirements.https ? '‚úÖ' : '‚ùå'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span>Service Worker:</span>
                            <span class="${requirements.serviceWorker ? 'text-green-600' : 'text-red-600'}">
                                ${requirements.serviceWorker ? '‚úÖ' : '‚ùå'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span>Manifest:</span>
                            <span class="${requirements.manifest ? 'text-green-600' : 'text-red-600'}">
                                ${requirements.manifest ? '‚úÖ' : '‚ùå'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span>Icons:</span>
                            <span class="${requirements.icons ? 'text-green-600' : 'text-red-600'}">
                                ${requirements.icons ? '‚úÖ' : '‚ùå'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span>Apple Touch Icon:</span>
                            <span class="${requirements.appleTouchIcon ? 'text-green-600' : 'text-red-600'}">
                                ${requirements.appleTouchIcon ? '‚úÖ' : '‚ùå'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span>App Installed:</span>
                            <span class="${isStandalone ? 'text-green-600' : 'text-yellow-600'}">
                                ${isStandalone ? '‚úÖ Yes' : '‚ùå No'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-100 rounded text-xs">
                        <strong>Browser:</strong> ${navigator.userAgent.split(' ')[0]}<br>
                        <strong>Protocol:</strong> ${location.protocol}<br>
                        <strong>Host:</strong> ${location.hostname}
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900">PWA Status</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${statusHtml}
                    <div class="mt-6 flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Make functions globally available
        window.installPWA = installPWA;
        window.hideInstallBanner = hideInstallBanner;
        window.showInstallInstructions = showInstallInstructions;
        window.showPWAStatus = showPWAStatus;
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
